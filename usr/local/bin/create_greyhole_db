#!/bin/sh
#
# Copyright (C) 2010-2012 Ian Moore <imooreyahoo@gmail.com>
# Copyright (C)      2013 OpenMediaVault Plugin Developers
#
# This file is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# any later version.
#
# This file is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this file. If not, see <http://www.gnu.org/licenses/>.

set -e

PWDFILE="/tmp/.openmediavault-greyhole-mysql-pwd"

if [ ! -f ${PWDFILE} ]; then
    exit 2
fi

MYSQLROOTPW=`cat ${PWDFILE}`
rm -f ${PWDFILE}

# Create Database/Table
TMPFILE="$(mktemp)"

cat <<EOF >> "${TMPFILE}"
CREATE DATABASE IF NOT EXISTS greyhole;

GRANT USAGE ON * . * TO  'greyhole'@'localhost' IDENTIFIED BY  '${PASSWORD}' WITH MAX_QUERIES_PER_HOUR 0 MAX_CONNECTIONS_PER_HOUR 0 MAX_UPDATES_PER_HOUR 0 MAX_USER_CONNECTIONS 0 ;

GRANT ALL PRIVILEGES ON  greyhole . * TO  'greyhole'@'localhost';

CREATE TABLE IF NOT EXISTS  greyhole.settings (
name TINYTEXT NOT NULL,
value TEXT NOT NULL,
PRIMARY KEY ( name(255) )
) ENGINE = MYISAM;

INSERT IGNORE INTO greyhole.settings (name, value) VALUES ('last_read_log_smbd_line', '0');
INSERT IGNORE INTO greyhole.settings (name, value) VALUES ('last_OOS_notification', '0');

CREATE TABLE IF NOT EXISTS greyhole.tasks (
    id bigint(20) unsigned NOT NULL AUTO_INCREMENT,
    action varchar(10) NOT NULL,
    share tinytext NOT NULL,
    full_path tinytext,
    additional_info tinytext,
    complete enum('yes','no','frozen','thawed','idle') NOT NULL,
    event_date timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (id),
    KEY find_next_task (complete,share(64),id)
) ENGINE=MyISAM;

CREATE TABLE IF NOT EXISTS greyhole.tasks_completed (
id BIGINT UNSIGNED NOT NULL,
action VARCHAR( 10 ) NOT NULL,
share TINYTEXT NOT NULL,
full_path TINYTEXT NULL,
additional_info TINYTEXT NULL,
complete ENUM( 'yes',  'no' ) NOT NULL,
event_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) ENGINE = MYISAM;
EOF

mysql --user=root --password=${MYSQLROOTPW} < ${TMPFILE}